<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta name="keywords" content="hexo, andy" />
    <title>
        aaaaaAndy
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="img/favicon.ico" />
     
<link rel="stylesheet" href="/blog/css/style.css">


    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css" />
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
<!--    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@2.0.0/dist/main.js"></script>-->

    <script>
        // infiniteScroll()

        window.addEventListener('DOMContentLoaded', function () {
            const [
                mainTitle,
                mobileMenu,
                mobileMainTitle,
                mobileMenuBtn,
                ipadMenuBtn,
                aside,
                closeBtn,
            ] = getEle(
                '#main-title',
                '.mobile-menu',
                '.mobile-menu h3',
                '.mobile-menu button',
                '.ipad-menu',
                'aside',
                'aside .close',
            )
            const io = new IntersectionObserver(entries => {
                if (entries[0].intersectionRatio <= 0) {
                    mobileMainTitle.classList.remove('invisibile')
                } else {
                    mobileMainTitle.classList.add('invisibile')
                }
            })
            io.observe(mainTitle)

            clickToggleAside(mobileMenuBtn)
            clickToggleAside(ipadMenuBtn)
            clickToggleAside(closeBtn, false)

            const isMenuVisible = window.getComputedStyle(mobileMenu).display !== 'none'
            if (isMenuVisible) document.body.style.background = 'none'

            function getEle(...args) {
                return args.map(arg => document.querySelector(arg))
            }

            function clickToggleAside(btn, show = true) {
                btn.addEventListener('click', function () {
                    if (show) {
                        aside.style.display = 'block'
                    } else {
                        aside.style.display = 'none'
                    }
                })
            }
        })
    </script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
    <div class="container">
        <header class="header">
    <nav class="mobile-menu" style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <h3 class="invisibile">
            <a href="/blog/" class="logo">
                aaaaaAndy
            </a>
        </h3>
        <button class="menu">menu</button>
    </nav>

    <button class="ipad-menu menu">menu</button>

    <h1 class="title" id="main-title">
        <a href="/blog/" class="logo">
            aaaaaAndy
        </a>
    </h1>
    <h2 class="desc">
        
    </h2>

    <div class="links">
        <ul id="menu-inner" class="menu-inner">
            
            <li class="menu-inner-item">
                <a href="/blog/">
                    Home
                </a>
            </li>
            
            <li class="menu-inner-item">
                <a href="/blog/category">
                    Category
                </a>
            </li>
            
            <li class="menu-inner-item">
                <a href="/blog/tag">
                    Tag
                </a>
            </li>
            
            <li class="menu-inner-item">
                <a href="/blog/about">
                    About
                </a>
            </li>
            
        </ul>
    </div>
</header>

        <main class="main">
            <article class="post">
    
    
    <h4 class="post-cat">
        <a href="/blog/categories/%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84JavaScript/">
            编写可维护的JavaScript
        </a>
    </h4>
    
    
    <h2 class="post-title">
        编写可维护的JavaScript-事件处理
    </h2>
    <ul class="post-date">
        <li>
            2018-08-23
        </li>
        <li>
            aaaaaAndy
        </li>
    </ul>
    <div class="post-content">
        <p>在所有JavaScript应用中事件处理都是非常重要的。所有的JavaScript均通过事件绑定到UI上。</p>
<p>很多开发者都很了解，当事件触发时，事件对象（event对象）会作为回调参数传入事件处理程序中。event对象包含所有和事件相关的信息，包括事件的宿主以及其他和事件类型相关的数据。鼠标事件会将其位置信息暴露的event对象上，键盘事件会将按键信息暴露在event对象上，触屏事件会将触摸位置和持续事件暴露在event对象上，只有提供了所有这些信息，UI才会正确地执行交互。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不好的写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> popup = <span class="built_in">document</span>.getElementById(<span class="string">'popup'</span>);</span><br><span class="line">    popup.style.left = event.clientX + <span class="string">'px'</span>;</span><br><span class="line">    popup.style.top = event.clientY + <span class="string">'px'</span>;</span><br><span class="line">    popup.className = <span class="string">'reveal'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addListener(element, <span class="string">'click'</span>, handleClick);</span><br></pre></td></tr></table></figure>

<p>这段代码只用到了event的两个属性：clientX和clientY。在将元素显示到页面之前先用这两个属性给它定位，尽管这段代码看起来非常简单并且没有什么问题，但实际上是不好的写法，因为这种做法尤其局限性。</p>
<h1 id="1-隔离应用逻辑"><a href="#1-隔离应用逻辑" class="headerlink" title="1. 隔离应用逻辑"></a>1. 隔离应用逻辑</h1><p>将应用逻辑从所有事件处理程序中抽离出来的做法是一种最佳实践，因为说不定什么时候其他地方就会触发同一段逻辑。这样多个事件的处理程序执行了同样的逻辑，而你的代码却被不小心赋值了多份。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的写法 - 拆分应用逻辑</span></span><br><span class="line"><span class="keyword">var</span> MyApplication = &#123;</span><br><span class="line">    handleClick: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.showPopup(event);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    showPopup: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> popup = <span class="built_in">document</span>.getElementById(<span class="string">'popup'</span>);</span><br><span class="line">        popup.style.left = event.clientX + <span class="string">'px'</span>;</span><br><span class="line">        popup.style.top = event.clientY + <span class="string">'px'</span>;</span><br><span class="line">        popup.className = <span class="string">'reveal'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addListener(element, <span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    MyApplication.handleClick(event);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>之前在事件处理程序中包含的应用逻辑现在拆分了出来，现在handleClick方法只做一件事情，即调用showPopup方法，这样使得其他相同逻辑的事件处理程序调用同一段逻辑代码更加剧方便。</p>
<h1 id="2-不要分发事件对象"><a href="#2-不要分发事件对象" class="headerlink" title="2. 不要分发事件对象"></a>2. 不要分发事件对象</h1><p>在剥离出应用逻辑之后，上段实例代码还存在一个问题，即event对象被无限制地分发，它从匿名的事件处理函数传入handleClick，然后又传入showPopup。正如上文所说，event对象上包含很多和事件相关的额外信息，而这段代码只用到了其中两个而已。这种方法在大型web应用中是不可取的，代码不够明晰就会导致BUG。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的写法</span></span><br><span class="line"><span class="keyword">var</span> MyApplication = &#123;</span><br><span class="line">    handleClick: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.showPopup(event.clientX, event.clientY);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    showPopup: <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> popup = <span class="built_in">document</span>.getElementById(<span class="string">'popup'</span>);</span><br><span class="line">        popup.style.left = x + <span class="string">'px'</span>;</span><br><span class="line">        popup.style.top = y + <span class="string">'px'</span>;</span><br><span class="line">        popup.className = <span class="string">'reveal'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addListener(element, <span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    MyApplication.handleClick(event);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在这段代码中，handleClick将x坐标和y坐标传入了showPopup中，代替了之前传入的事件对象，可以很清晰地看到showPopup所期望传入的参数，并且在测试或代码的任意位置都可以很轻易地调用这段逻辑。</p>
<p>当处理事件时，最好让事件处理程序成为接触到event对象的唯一的函数，事件处理程序应当在进入应用逻辑之前针对event对象执行任何必要的操作，，包括组织默认事件或阻止事件冒泡，都应当直接包含在事件处理程序中。比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的写法</span></span><br><span class="line"><span class="keyword">var</span> MyApplication = &#123;</span><br><span class="line">    handleClick: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阻止默认事件</span></span><br><span class="line">        event.preventDefault();</span><br><span class="line">        event.stopPropagation();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 传入应用逻辑</span></span><br><span class="line">        <span class="keyword">this</span>.showPopup(event.clientX, event.clientY);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    showPopup: <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> popup = <span class="built_in">document</span>.getElementById(<span class="string">'popup'</span>);</span><br><span class="line">        popup.style.left = x + <span class="string">'px'</span>;</span><br><span class="line">        popup.style.top = y + <span class="string">'px'</span>;</span><br><span class="line">        popup.className = <span class="string">'reveal'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addListener(element, <span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    MyApplication.handleClick(event);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<a id="more"></a>

    </div>
</article>
        </main>
    </div>
</body>

</html>
