<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="EventEmitter 是 NodeJS 的核心模块 events 中的类，用于对 NodeJS 中的事件进行统一管理，用 events 特定的 API 对事件进行添加、触发和移除等等，核心方法的模式类似于发布订阅   1. Node 中的 EventEmitter  EventEmitter本质上是一个观察者模式的实现。  观察者模式：它定义了对象间的一种一对多的关系，让多个观察者对象同时监听">
<meta property="og:type" content="article">
<meta property="og:title" content="简单实现一个EventEmitter">
<meta property="og:url" content="https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/index.html">
<meta property="og:site_name" content="aaaaaAndy">
<meta property="og:description" content="EventEmitter 是 NodeJS 的核心模块 events 中的类，用于对 NodeJS 中的事件进行统一管理，用 events 特定的 API 对事件进行添加、触发和移除等等，核心方法的模式类似于发布订阅   1. Node 中的 EventEmitter  EventEmitter本质上是一个观察者模式的实现。  观察者模式：它定义了对象间的一种一对多的关系，让多个观察者对象同时监听">
<meta property="og:locale" content="zh">
<meta property="article:published_time" content="2019-03-12T12:02:06.000Z">
<meta property="article:modified_time" content="2020-07-25T02:52:00.880Z">
<meta property="article:author" content="aaaaaAndy">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="EventEmitter">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/blog/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>简单实现一个EventEmitter</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/blog/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/category">Category</a></li>
         
          <li><a href="/blog/tag">Tag</a></li>
         
          <li><a href="/blog/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/blog/2019/04/14/technology/%E7%BD%91%E9%A1%B5%E6%B8%B2%E6%9F%93/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/blog/2019/03/12/git/git-log/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/" target="_blank" rel="noopener"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&text=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&is_video=false&description=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=简单实现一个EventEmitter&body=Check out this article: https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&name=简单实现一个EventEmitter&description=EventEmitter 是 NodeJS 的核心模块 events 中的类，用于对 NodeJS 中的事件进行统一管理，用 events 特定的 API 对事件进行添加、触发和移除等等，核心方法的模式类似于发布订阅


1. Node 中的 EventEmitter

EventEmitter本质上是一个观察者模式的实现。

观察者模式：它定义了对象间的一种一对多的关系，让多个观察者对象同时监听某一个主题对象，当一个对象发生改变时，所有依赖于它的对象都将得到通知。

1
2
3
4
5
6
7
8
9


// Node 中的 EventEmitter 简单用法
let events = r"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Node-中的-EventEmitter"><span class="toc-number">1.</span> <span class="toc-text">1. Node 中的 EventEmitter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-简单实现一个-EventEmitter"><span class="toc-number">2.</span> <span class="toc-text">2. 简单实现一个 EventEmitter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-EventEmitter-模块的异常处理"><span class="toc-number">3.</span> <span class="toc-text">3. EventEmitter 模块的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-try…catch-方法"><span class="toc-number">3.1.</span> <span class="toc-text">1. try…catch 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-process-on-‘uncaughtException’-方法"><span class="toc-number">3.2.</span> <span class="toc-text">2. process.on(‘uncaughtException’) 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-EventEmitter-源码实现"><span class="toc-number">4.</span> <span class="toc-text">4. EventEmitter 源码实现</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        简单实现一个EventEmitter
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">aaaaaAndy</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-12T12:02:06.000Z" itemprop="datePublished">2019-03-12</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/blog/tags/EventEmitter/" rel="tag">EventEmitter</a>, <a class="tag-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>EventEmitter 是 NodeJS 的核心模块 events 中的类，用于对 NodeJS 中的事件进行统一管理，用 events 特定的 API 对事件进行添加、触发和移除等等，核心方法的模式类似于发布订阅</p>
<h2 id="1-Node-中的-EventEmitter"><a href="#1-Node-中的-EventEmitter" class="headerlink" title="1. Node 中的 EventEmitter"></a>1. Node 中的 EventEmitter</h2><p>EventEmitter本质上是一个观察者模式的实现。</p>
<p>观察者模式：<strong><em>它定义了对象间的一种一对多的关系，让多个观察者对象同时监听某一个主题对象，当一个对象发生改变时，所有依赖于它的对象都将得到通知。</em></strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node 中的 EventEmitter 简单用法</span></span><br><span class="line"><span class="keyword">let</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">let</span> eventEmitter = <span class="keyword">new</span> events.EventEmitter();</span><br><span class="line"></span><br><span class="line">eventEmitter.on(<span class="string">'show'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'this is show callback'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">eventEmitter.emit(<span class="string">'show'</span>);</span><br></pre></td></tr></table></figure>

<p>eventEmitter是EventEmitter模块的一个实例，eventEmitter的emit方法，发出show事件，通过eventEmitter的on方法监听，从而执行相应的函数。</p>
<h2 id="2-简单实现一个-EventEmitter"><a href="#2-简单实现一个-EventEmitter" class="headerlink" title="2. 简单实现一个 EventEmitter"></a>2. 简单实现一个 EventEmitter</h2><p>接下来我们简单实现一个EventEmitter模块的基础功能emit和on。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>._events = &#123;&#125;;      <span class="comment">// 保存事件</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加事件监听</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;String&#125;</span>   </span>eventName 监听的对象名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>callback  事件处理函数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  on (eventName, callback) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._events) &#123;</span><br><span class="line">      <span class="keyword">this</span>._events = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._events[eventName]) &#123;</span><br><span class="line">      <span class="keyword">this</span>._events[eventName] = [];     <span class="comment">// 每个监听的对象，要处理的事件存放在一个数组里</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>._events[eventName].push(callback);     <span class="comment">// 添加监听事件</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 触发事件监听函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;String&#125;</span>    </span>eventName 监听的对象名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;...[type]&#125;</span> </span>args      传入的参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  emit (eventName, ...args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._events[eventName]) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>._events[eventName].length; i++) &#123;</span><br><span class="line">        <span class="keyword">this</span>._events[eventName][i](...args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 删除事件监听</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="variable">eventName</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="variable">callback</span></span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  off (eventName, callback) &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      <span class="keyword">this</span>._events[eventName] = <span class="keyword">this</span>._events[eventName].filter(<span class="function"><span class="params">fn</span> =&gt;</span> fn !== callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="keyword">this</span>._events[eventName];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 只执行一次事件监听</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">eventName</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">callback</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  once (eventName, callback) &#123;</span><br><span class="line">    <span class="keyword">let</span> onceFun = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">      callback.apply(<span class="keyword">this</span>, args);</span><br><span class="line">      <span class="keyword">this</span>.off(eventName, onceFun);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.on(eventName, onceFun);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-EventEmitter-模块的异常处理"><a href="#3-EventEmitter-模块的异常处理" class="headerlink" title="3. EventEmitter 模块的异常处理"></a>3. EventEmitter 模块的异常处理</h2><p>为什么要添加异常处理模块？因为node中有一个特殊的事件error，如果异常没有被捕获，就会触发 process 的 uncaughtException 事件抛出，如果没有注册该事件的监听器，则 Node.js 会在控制台打印该异常的堆栈信息，并结束进程。</p>
<h3 id="1-try…catch-方法"><a href="#1-try…catch-方法" class="headerlink" title="1. try…catch 方法"></a>1. try…catch 方法</h3><p>通过 try…catch 可以来捕获错误：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> x = x;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上，赋值语句的错误会被捕获，但是<strong><em>try…catch不能捕获非阻塞或者异步函数里的异常</em></strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    process.nextTick(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> x = x;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上，因为process.nextTick是异步的，因此在process.nextTick内部的错误不能被捕获。</p>
<h3 id="2-process-on-‘uncaughtException’-方法"><a href="#2-process-on-‘uncaughtException’-方法" class="headerlink" title="2. process.on(‘uncaughtException’) 方法"></a>2. process.on(‘uncaughtException’) 方法</h3><p>node中提供了一个最外层的兜底的捕获异常的方法。非阻塞或者异步函数中的异常都会抛出到最外层，如果异常没有被捕获，那么会暴露出来，被最外层的process.on(‘uncaughtException’)所捕获。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">let</span> x = x; <span class="comment">//第二个x在使用前未定义，会抛出异常</span></span><br><span class="line">  &#125;,<span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'该异常已经被捕获'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br><span class="line">process.on(<span class="string">'uncaughtException'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;<span class="built_in">console</span>.log(err)&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="4-EventEmitter-源码实现"><a href="#4-EventEmitter-源码实现" class="headerlink" title="4. EventEmitter 源码实现"></a>4. EventEmitter 源码实现</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * EventEmitter 构造函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EventEmitter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//私有属性，保存订阅方法</span></span><br><span class="line">  <span class="keyword">this</span>._events = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认最大监听数</span></span><br><span class="line">EventEmitter.defaultMaxListeners = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * on方法，该方法用于订阅事件，在旧版本的node.js中是addListener方法，它们是同一个函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>type       监听的对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>listener 监听的回调函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Boolean&#125;</span> </span>flag      是否先于其他同类监听事件执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventEmitter.prototype.on = EventEmitter.prototype.addListener = <span class="function"><span class="keyword">function</span> (<span class="params">type, listener, flag</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//保证存在实例属性</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._events) <span class="keyword">this</span>._events = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._events[type]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;     <span class="comment">//从头部插入</span></span><br><span class="line">            <span class="keyword">this</span>._events[type].unshift(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>._events[type].push(listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>._events[type] = [listener];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//绑定事件，触发newListener</span></span><br><span class="line">    <span class="keyword">if</span> (type !== <span class="string">'newListener'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'newListener'</span>, type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * emit方法: 将订阅方法取出执行，使用call方法来修正this的指向，使其指向子类的实例。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;String&#125;</span>    </span>type 监听的对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;...[type]&#125;</span> </span>args 参数传递</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventEmitter.prototype.emit = <span class="function"><span class="keyword">function</span> (<span class="params">type, ...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._events[type]) &#123;</span><br><span class="line">        <span class="keyword">this</span>._events[type].forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn.call(<span class="keyword">this</span>, ...args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * once方法，它的功能是将事件订阅“一次”，当这个事件触发过就不会再次触发了。</span></span><br><span class="line"><span class="comment"> * 其原理是将订阅的方法再包裹一层函数，在执行后将此函数移除即可。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>type     监听的对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>listener 监听的回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventEmitter.prototype.once = <span class="function"><span class="keyword">function</span> (<span class="params">type, listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 中间函数，在调用完之后立即删除订阅</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">only</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        listener();</span><br><span class="line">        _this.removeListener(type, only);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// origin保存原回调的引用，用于remove时的判断</span></span><br><span class="line">    only.origin = listener;</span><br><span class="line">    <span class="keyword">this</span>.on(type, only);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * off方法即为退订，原理同观察者模式一样，将订阅方法从数组中移除即可。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;String&#125;</span>   </span>type     监听的对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>listener 监听的回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventEmitter.prototype.off = EventEmitter.prototype.removeListener = <span class="function"><span class="keyword">function</span> (<span class="params">type, listener</span>) </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._events[type]) &#123;</span><br><span class="line">        <span class="comment">// 过滤掉退订的方法，从数组中移除</span></span><br><span class="line">        <span class="keyword">this</span>._events[type] = <span class="keyword">this</span>._events[type].filter(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fn !== listener &amp;&amp; fn.origin !== listener</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/category">Category</a></li>
         
          <li><a href="/blog/tag">Tag</a></li>
         
          <li><a href="/blog/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Node-中的-EventEmitter"><span class="toc-number">1.</span> <span class="toc-text">1. Node 中的 EventEmitter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-简单实现一个-EventEmitter"><span class="toc-number">2.</span> <span class="toc-text">2. 简单实现一个 EventEmitter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-EventEmitter-模块的异常处理"><span class="toc-number">3.</span> <span class="toc-text">3. EventEmitter 模块的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-try…catch-方法"><span class="toc-number">3.1.</span> <span class="toc-text">1. try…catch 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-process-on-‘uncaughtException’-方法"><span class="toc-number">3.2.</span> <span class="toc-text">2. process.on(‘uncaughtException’) 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-EventEmitter-源码实现"><span class="toc-number">4.</span> <span class="toc-text">4. EventEmitter 源码实现</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/" target="_blank" rel="noopener"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&text=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&is_video=false&description=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=简单实现一个EventEmitter&body=Check out this article: https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&title=简单实现一个EventEmitter" target="_blank" rel="noopener"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://aaaaaandy.github.io/blog/2019/03/12/JavaScript/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAEventEmitter/&name=简单实现一个EventEmitter&description=EventEmitter 是 NodeJS 的核心模块 events 中的类，用于对 NodeJS 中的事件进行统一管理，用 events 特定的 API 对事件进行添加、触发和移除等等，核心方法的模式类似于发布订阅


1. Node 中的 EventEmitter

EventEmitter本质上是一个观察者模式的实现。

观察者模式：它定义了对象间的一种一对多的关系，让多个观察者对象同时监听某一个主题对象，当一个对象发生改变时，所有依赖于它的对象都将得到通知。

1
2
3
4
5
6
7
8
9


// Node 中的 EventEmitter 简单用法
let events = r"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 aaaaaAndy
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/category">Category</a></li>
         
          <li><a href="/blog/tag">Tag</a></li>
         
          <li><a href="/blog/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/blog/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/blog/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/blog/lib/jquery/jquery.min.js"></script>


<script src="/blog/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/blog/js/main.js"></script>





